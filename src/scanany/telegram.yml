
- use:     
    - axios-plugin
    - cheerio-plugin
    - js-plugin

- fetch:
    request:
      method: GET
      url: 
        $ref: options.task.params.url
    transform:
      apply:
        - project: data
        - html->$
    into: page

- all:
    $ref: page
    select: div.tgme_widget_message_bubble
    into: res
        
- each:
    in:
      $ref: res
    as: item
    indexed-by: index
    into: messages
    
    apply:
    
      - map:
    
          - $ref: options
            into: res

          - $ref: item
            transform: 
              apply:
                - html
                - html->$
            into: msg
      
      - once:
          $ref: msg
          select: div.tgme_widget_message_text
          apply:  
            - transform: 
                apply:
                  - text
                  - js: '(command, context, value) => value.replace(/[\u2000-\uffff]+/g, " ")'
              into: res.scraper.message.text
            
            - transform: html
              into: res.scraper.message.raw.html
      
      - map: 
          $ref: res.scraper.message.text
          transform: md5
          into: res.scraper.message.md5 

      - once:
          $ref: msg
          select: time
          apply:
            - transform: 
                apply:
                  - attributes: datetime
                  - project: datetime
              into: res.scraper.message.publishedAt
      
      - all:
          $ref: msg
          select: div.tgme_widget_message_text a
          into: $l

      - map:
          $ref: $l
          transform:
            js: (command, context, value) => value.map( a => a.attr("href"))
          into: res.scraper.message.$links      

      - transform: date
        into: res.scraper.scrapedAt

      - return: res

- return: messages
